---
title: "CanadianRetailSales"
output: html_document
---

In this document we develop a simple forecasting model of Canadian Retail Sales.
The first thing I done was to look at the data you provided. It describes unadjusted and seasonally adjusted Monthly Retail Trades in Canada from **January 2000** to **July 2015**.

Looking at the date the data were accessed the 20th of October 2015. Looking at the Statistics Canada website, I first noticed that the data were last modified the 22nd of October 2015 and that the numbers were slightly different.

Finally, Available data ends in August 2015 on the Statistics Canada website. Since the exercise is to predict next month's unadjusted Canadian retail sales I decided to not include that entry in the base dataset, since it might be used later on to evaluate the
quality of our mondel.

```{r, echo=FALSE, message=FALSE}
library(plyr)
library(dplyr)
library(xts)
library(zoo)
library(ggplot2)
library(forecast)
library(tseries)
```
## Preliminaries:

### Formatting the data:

First the data provided is not ideal for an analysis using R so I had to reformat it.

```{r}
base.data <- read.csv('./data/cansim__Jan-2000_Jul-2015.csv', header=FALSE)

data <-
  base.data %>%
  select(-V1, -V2, -V3) %>% # Remove the description columns
  slice(5:7) %>%            # Only select row containing data
  t %>% data.frame %>%      # Transpose and cast to data.frame
  rename(adjustments=X1) %>%
  rename(unadjusted=X2) %>%
  rename(seasonally.adjusted=X3) %>%
  mutate(seasonally.adjusted=as.numeric(as.character(seasonally.adjusted))) %>%
  mutate(unadjusted=as.numeric(as.character(unadjusted))) %>%
  mutate(adjustments=as.Date(
                        as.character(x=paste("01-", adjustments, sep="")),
                        format="%d-%b-%Y")
         )# Converts the adjustments. You need to paste a day to be able to convert such format to a date.
```



Now it will be easier to work with such format.

### First look at the data:

```{r}
g.data.with.regression <-
  ggplot(data, aes(x=adjustments, y=unadjusted, color='unadjusted')) +
  geom_smooth(method='lm', color='black') + geom_line() +
  geom_line(data=data, aes(x=adjustments, y=seasonally.adjusted, color='seasonally.adjusted')) +
  xlab('Time') + ylab('Retail Sales')

g.data.with.regression
```

We want to build a model that can forecast unadjusted retail sales data, let's create a time series object for
that data.
```{r}
unadjusted.ts <- ts(data$unadjusted, frequency=12)
```

From here, we can note a few observations:

* The retail sales are strongly seasonal.
* The retail sales seems to follow a linear trend.
* The time plot shows a sudden change, particulary in 2009.
* The variability of the seasonal components seems constant.

### Stationarity:
From those observations, we can suppose that our time series is not stationary process.
But let's test that assumption using the **Augmented Dickey-Fuller Test**, the **Box test** and the **KPSS test**.


```{r  message=FALSE, warning=FALSE}
results = list(
  adf=adf.test(unadjusted.ts)$p.value < 0.05,
  box=Box.test(unadjusted.ts, lag=12, type='Ljung-Box')$p.value < 0.05,
  kpss=kpss.test(unadjusted.ts)$p.value > 0.05
)
results
```

From those test, we note that the three tests don't give the same results of stationarity.
Thus, we will assume the data is not stationary.

### Seasonality:

Seasonality of our dataset will be  key in its forecasting.
At glance, we can observe a 12 month pattern. But let's have a deeper look into it:

The evolution of the retail sales data seems to follow a linear trend, let's model it and remove the trend to the data. Then it will be easier to evaluate the seasonality of the retail sales data.

We model the trend using a linear regression.
```{r}
unadjusted.regression <- lm(data$unadjusted~data$adjustments)
```

Then we remove the trend from the data by simply getting the residuals of the regression
```{r}
unadjusted.residuals <- residuals(unadjusted.regression)
```

Looking at the auto-correlation of the retail sales data, we can then identify repeating patterns.
Another method to detrend the data is to look at its first difference. In the following plot, we compare the both approaches.
```{r}
unadjusted.residuals.ts <- ts(unadjusted.residuals, frequency=12)
first.diff.unadjusted.ts <- ts(diff(data$unadjusted), frequency=12)

par(mfrow=c(3,2))
plot(unadjusted.residuals, type='l')
plot(diff(data$unadjusted), type='l')
acf(unadjusted.residuals, lag=nrow(data)) # ACF of residuals
acf(diff(data$unadjusted), lag=nrow(data))
pacf(unadjusted.residuals) # PACF of residuals
pacf(diff(data$unadjusted))
seasonplot(unadjusted.residuals.ts)
seasonplot(first.diff.unadjusted.ts)

par(mfrow=c(1,1))
plot(decompose(ts(unadjusted.residuals, frequency=12)))
```
We observe spikes at every 12 lags (in months)


